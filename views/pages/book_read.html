
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PageFlipper</title>
  <style>
    /* General styles from globals.css and layout */
    :root {
      --background: 220 25% 10%;
      --foreground: 220 20% 90%;
      --card: 220 25% 15%;
      --card-foreground: 220 20% 90%;
      --primary: 210 80% 60%;
      --primary-foreground: 210 80% 10%;
      --accent: 200 90% 50%;
      --accent-foreground: 200 90% 95%;
      --border: 220 25% 30%;
      --muted-foreground: 220 15% 55%;
      --highlight-yellow: hsla(55, 100%, 50%, 0.4);
      --highlight-pink: hsla(330, 100%, 50%, 0.4);
      --highlight-blue: hsla(210, 100%, 50%, 0.4);
      --highlight-green: hsla(130, 100%, 50%, 0.4);
    }
    body {
      font-family: 'Literata', serif;
      background-color: hsl(var(--background));
      color: hsl(var(--foreground));
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, Helvetica, sans-serif;
      overflow-x: hidden;
    }
    main {
      display: flex;
      min-height: 100vh;
      width: 100%;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem 0; /* Add some vertical padding */
    }
    .pageflipper-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: 'Literata', serif;
      width: 100%;
    }

    /* Editor Toolbar */
    .editor-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background-color: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: 8px;
        margin-bottom: 1rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    .toolbar-button {
        background: none;
        border: none;
        color: hsl(var(--foreground));
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .toolbar-button:hover {
        background-color: hsl(var(--border));
    }
    .toolbar-button.active {
        background-color: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
    }
    .toolbar-button svg {
        width: 1rem;
        height: 1rem;
    }


    /* page-flipper.css */
    .book-container {
      width: 90vw;
      height: 80vh;
      max-width: 1200px;
      max-height: 800px;
      position: relative;
      perspective: 2500px;
      transition: transform 0.5s;
    }
    .book-container.closed {
        transform: scaleX(0.7);
    }
    .sheet {
      position: absolute;
      width: 50%;
      height: 100%;
      top: 0;
      left: 50%;
      transform-origin: left center;
      transition: transform 1s cubic-bezier(0.65, 0, 0.35, 1);
      transform-style: preserve-3d;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .sheet.flipped {
      transform: rotateY(-180deg);
    }
    .page {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      background-color: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      overflow: hidden;
    }
    .page-front {
      border-radius: 0 8px 8px 0;
    }
    .page-back {
      transform: rotateY(180deg);
      border-radius: 8px 0 0 8px;
    }
    .page.is-cover, .page.is-back-cover {
      background-color: hsl(var(--accent));
      color: hsl(var(--accent-foreground));
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .page.is-cover .page-content .editable-area {
        color: hsl(var(--accent-foreground));
        text-align: center;
        font-size: 1.2rem;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        gap: 0.8rem;
        height: 100%;
        width: 100%;
        padding-top: 5px;
    }
    .page.is-cover .cover-author {
        font-size: 0.9rem;
        opacity: 0.85;
        margin-bottom: 0.5rem;
        align-self: flex-start;
        margin-left: 1rem;
    }
    .page.is-cover .cover-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0;
        text-align: center;
        width: 100%;
    }
    .page.is-cover .cover-image {
        width: 200px;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.3);
    }
    .page.is-cover .cover-description {
        font-size: 0.8rem;
        line-height: 1.4;
        opacity: 0.9;
        max-width: 80%;
        text-align: center;
    }
    .page-content {
      padding: 2rem;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      overflow-y: auto;
      position: relative;
    }
    .page-number-left {
      position: absolute;
      bottom: 1rem;
      left: 1.5rem;
      font-size: 0.875rem;
      color: hsl(var(--muted-foreground));
    }
    .page-number-right {
      position: absolute;
      bottom: 1rem;
      right: 1.5rem;
      font-size: 0.875rem;
      color: hsl(var(--muted-foreground));
    }
    .editable-area {
      line-height: 1.6;
      width: 100%;
      height: 100%;
      background-color: transparent;
      border: none;
      resize: none;
      color: hsl(var(--foreground));
      font-size: 1em;
      padding: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      outline: none;
    }
    .editable-area img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
        cursor: pointer;
    }
    .editable-area table {
      width: 100%;
      border-collapse: collapse;
      margin: 1em 0;
    }
    .editable-area th, .editable-area td {
      border: 1px solid hsl(var(--border));
      padding: 8px;
      min-width: 50px;
    }
    .editable-area th {
      background-color: hsl(var(--background));
    }
    .editable-area:empty:before{
      content: attr(placeholder);
      pointer-events: none;
      display: block; /* For Firefox */
      color: hsl(var(--muted-foreground));
    }
    mark {
        position: relative;
        cursor: pointer;
        background-color: var(--highlight-yellow);
        border-radius: 3px;
        padding: 0.1em 0.2em;
    }
    mark:hover .highlight-note {
      display: block;
    }
    .highlight-note {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 0.8rem;
      width: 200px;
      margin-bottom: 8px;
      z-index: 100;
      white-space: pre-wrap;
    }

    /* Button styles */
    .button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      white-space: nowrap;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      line-height: 1.25rem;
      font-weight: 500;
      transition: background-color 150ms;
      height: 2.5rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
      border: none;
      background-color: hsl(var(--primary));
      color: hsl(var(--primary-foreground));
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    .button.icon-button {
      padding: 0.5rem;
      width: 2.5rem;
    }
    .button:hover {
      background-color: hsl(var(--primary) / 0.9);
    }
    .button:disabled {
      pointer-events: none;
      opacity: 0.5;
    }
    .button svg {
      width: 1rem;
      height: 1rem;
    }
    .controls {
      margin-top: 2rem;
      display: flex;
      width: 90%;
      max-width: 1200px;
      justify-content: space-between;
      align-items: center;
    }

    /* Highlight Popover */
    #highlight-popover {
        position: fixed;
        background-color: #333;
        border-radius: 6px;
        padding: 4px;
        display: none;
        gap: 4px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    #highlight-popover button {
        background: none;
        border: 1px solid #555;
        color: white;
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 0.8rem;
    }
    #highlight-popover button:hover {
        background: #555;
    }

    /* Generic Modal Styles */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        z-index: 1000;
        display: none;
    }
    .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: hsl(var(--card));
        color: hsl(var(--card-foreground));
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        z-index: 1001;
        width: 350px;
        display: none;
        box-sizing: border-box;
    }
    .modal h3 {
        margin-top: 0;
    }
    .modal label {
        display: block;
        margin-top: 1rem;
        color: hsl(var(--muted-foreground));
        font-size: 0.9rem;
    }
    .modal input[type="text"],
    .modal input[type="number"],
    .modal input[type="color"],
    .modal textarea {
        width: 100%;
        background-color: hsl(var(--background));
        color: hsl(var(--foreground));
        border: 1px solid hsl(var(--border));
        border-radius: 4px;
        padding: 8px;
        margin-top: 0.5rem;
        box-sizing: border-box;
    }
    .modal-buttons {
        margin-top: 1.5rem;
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }

    /* Highlight Modal Specifics */
    #highlight-modal textarea {
        min-height: 80px;
    }
    .color-picker {
        display: flex;
        gap: 10px;
        margin-top: 1rem;
    }
    .color-box {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid transparent;
        transition: border-color 0.2s;
    }
    .color-box.selected {
        border-color: hsl(var(--foreground));
    }
    
    #loader {
        font-size: 1.5rem;
        color: hsl(var(--foreground));
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossOrigin="anonymous" />
  <link href="https://fonts.googleapis.com/css2?family=Literata:ital,opsz,wght@0,7..72,400;0,7..72,700;1,7..72,400;1,7..72,700&display=swap" rel="stylesheet" />
</head>
<body>
  <main>
    <div id="loader">Loading your book...</div>
    <div class="pageflipper-container" style="display: none;">
      <div class="editor-toolbar">
        <button id="bold-btn" class="toolbar-button" title="Bold (Ctrl+B)">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path></svg>
        </button>
        <button id="italic-btn" class="toolbar-button" title="Italic (Ctrl+I)">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="4" x2="10" y2="4"></line><line x1="14" y1="20" x2="5" y2="20"></line><line x1="15" y1="4" x2="9" y2="20"></line></svg>
        </button>
        <button id="underline-btn" class="toolbar-button" title="Underline (Ctrl+U)">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3"></path><line x1="4" y1="21" x2="20" y2="21"></line></svg>
        </button>
        <button id="image-btn" class="toolbar-button" title="Insert Image">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0-0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
        </button>
        <button id="fontsize-btn" class="toolbar-button" title="Font Size">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 7 4"></polyline><polyline points="20 7 20 4 17 4"></polyline><polyline points="14 20 14 17 17 17"></polyline><polyline points="10 20 10 17 7 17"></polyline><line x1="7" y1="12" x2="17" y2="12"></line></svg>
        </button>
        <button id="fontcolor-btn" class="toolbar-button" title="Font Color">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 14c-2.5 0-4.5-2-4.5-4.5S9.5 5 12 5s4.5 2 4.5 4.5-2 4.5-4.5 4.5zm0-2c-1.38 0-2.5-1.12-2.5-2.5S10.62 7 12 7s2.5 1.12 2.5 2.5S13.38 12 12 12zm0 8c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6z"/><path d="M20.71 14.71l-1.42 1.42c-.39.39-1.02.39-1.41 0l-1.17-1.17c-.39-.39-.39-1.02 0-1.41l1.42-1.42c.39-.39 1.02-.39 1.41 0l1.17 1.17c.39.39.39 1.02 0 1.41z"/></svg>
        </button>
        <button id="table-btn" class="toolbar-button" title="Insert Table">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line></svg>
        </button>
        <input type="file" id="image-upload" accept="image/*" style="display: none;" />
      </div>

      <div id="book-container" class="book-container">
        <!-- Sheets will be generated here by JavaScript -->
      </div>
       <div class="controls">
        <button id="prev-btn" class="button">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
          Previous
        </button>
        
        <button id="next-btn" class="button">
          Next
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
        </button>

        <button id="add-page-btn" class="button icon-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </button>
      </div>
    </div>
  </main>

  <!-- Highlight Popover -->
  <div id="highlight-popover">
    <button id="popover-highlight-btn">Highlight</button>
    <button id="popover-remove-highlight-btn">Remove</button>
  </div>

  <!-- Highlight Modal -->
  <div id="highlight-modal-overlay" class="modal-overlay"></div>
  <div id="highlight-modal" class="modal">
      <h3>Add a Note</h3>
      <textarea id="highlight-note-input" placeholder="Enter your explanation here..."></textarea>
      
      <h3>Choose Color</h3>
      <div class="color-picker">
          <div class="color-box selected" style="background-color: var(--highlight-yellow);" data-color="var(--highlight-yellow)"></div>
          <div class="color-box" style="background-color: var(--highlight-pink);" data-color="var(--highlight-pink)"></div>
          <div class="color-box" style="background-color: var(--highlight-blue);" data-color="var(--highlight-blue)"></div>
          <div class="color-box" style="background-color: var(--highlight-green);" data-color="var(--highlight-green)"></div>
      </div>
      
      <div class="modal-buttons">
          <button id="highlight-modal-cancel-btn" class="button" style="background-color: hsl(var(--border)); color: hsl(var(--foreground));">Cancel</button>
          <button id="highlight-modal-save-btn" class="button">Save</button>
      </div>
  </div>

  <!-- Generic Input Modal -->
  <div id="input-modal-overlay" class="modal-overlay"></div>
  <div id="input-modal" class="modal">
      <h3 id="input-modal-title">Enter Value</h3>
      <div id="input-modal-content"></div>
      <div class="modal-buttons">
          <button id="input-modal-cancel-btn" class="button" style="background-color: hsl(var(--border)); color: hsl(var(--foreground));">Cancel</button>
          <button id="input-modal-save-btn" class="button">OK</button>
      </div>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- CONFIGURATION ---
      function getBookIdFromUrl() {
          const pathParts = window.location.pathname.split('/');
          const readIndex = pathParts.indexOf('read');
          if (readIndex > -1 && pathParts.length > readIndex + 1) {
              const bookId = pathParts[readIndex + 1];
              if (bookId && !isNaN(parseInt(bookId, 10))) {
                  return parseInt(bookId, 10);
              }
          }
          console.warn("Could not find book ID in URL, falling back to 1. URL should be like /read/1");
          return 1; 
      }
      const BOOK_ID = getBookIdFromUrl();

      const FLIP_DURATION = 1000;
      const DEBOUNCE_DELAY = 1500; // ms to wait after user stops typing to save

      // --- STATE ---
      let book = null; // { id, title, pages: [...] }
      let currentSpread = 0;
      let isFlipping = false;
      let currentSelection = null;
      let activeEditableArea = null;
      let selectedImage = null;
      let debounceTimeout = null;

      // --- DOM ELEMENTS ---
      const loader = document.getElementById('loader');
      const pageFlipperContainer = document.querySelector('.pageflipper-container');
      const bookContainer = document.getElementById('book-container');
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');
      const addPageBtn = document.getElementById('add-page-btn');
      
      // Popovers and Modals
      const highlightPopover = document.getElementById('highlight-popover');
      const popoverHighlightBtn = document.getElementById('popover-highlight-btn');
      const popoverRemoveHighlightBtn = document.getElementById('popover-remove-highlight-btn');
      const highlightModalOverlay = document.getElementById('highlight-modal-overlay');
      const highlightModal = document.getElementById('highlight-modal');
      const noteInput = document.getElementById('highlight-note-input');
      const colorPicker = document.querySelector('.color-picker');
      const highlightModalCancelBtn = document.getElementById('highlight-modal-cancel-btn');
      const highlightModalSaveBtn = document.getElementById('highlight-modal-save-btn');
      const inputModalOverlay = document.getElementById('input-modal-overlay');
      const inputModal = document.getElementById('input-modal');
      const inputModalTitle = document.getElementById('input-modal-title');
      const inputModalContent = document.getElementById('input-modal-content');
      const inputModalCancelBtn = document.getElementById('input-modal-cancel-btn');
      const inputModalSaveBtn = document.getElementById('input-modal-save-btn');
      let inputModalCallback = null;

      // Toolbar
      const boldBtn = document.getElementById('bold-btn');
      const italicBtn = document.getElementById('italic-btn');
      const underlineBtn = document.getElementById('underline-btn');
      const imageBtn = document.getElementById('image-btn');
      const imageUpload = document.getElementById('image-upload');
      const fontsizeBtn = document.getElementById('fontsize-btn');
      const fontcolorBtn = document.getElementById('fontcolor-btn');
      const tableBtn = document.getElementById('table-btn');

      // --- API FUNCTIONS ---
      async function fetchBook() {
        try {
          // IMPORTANT: This now calls the dedicated JSON API endpoint
          const response = await fetch(`/books/${BOOK_ID}/read`, {
            headers: {
              'Accept': 'application/json'
            }
          });
          if (!response.ok) {
            let errorDetails = `HTTP error! status: ${response.status}`;
            try {
                // Try to get more specific error from JSON response
                const errorJson = await response.clone().json();
                errorDetails = errorJson.error || JSON.stringify(errorJson);
            } catch (e) {
                 // If the response is not JSON (e.g., it's an HTML error page), show that
                 const text = await response.clone().text();
                 errorDetails += ' - Response is not valid JSON: ' + text.substring(0, 200);
            }
            throw new Error(errorDetails);
          }
          book = await response.json();
          if (!book.pages) {
            book.pages = [];
          }
          // The backend should already sort pages, but we do it again just in case
          book.pages.sort((a, b) => a.page_number - b.page_number);
          
          loader.style.display = 'none';
          pageFlipperContainer.style.display = 'flex';
          renderBook();
        } catch (error) {
          console.error("Failed to load book:", error);
          loader.textContent = `Error loading book. Please check if the backend is running. Details: ${error.message}`;
        }
      }

      async function updatePage(pageId, pageData) {
        try {
          const response = await fetch(`/books/${BOOK_ID}/pages/${pageId}/edit`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(pageData)
          });
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          console.log(`Page ${pageId} updated successfully.`);
        } catch(error) {
          console.error(`Failed to update page ${pageId}:`, error);
        }
      }
      
      async function createPage(pageData) {
          try {
              const response = await fetch(`/books/${BOOK_ID}/pages`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(pageData)
              });
              if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
              const newPage = await response.json();
              console.log("New page created:", newPage);
              return newPage;
          } catch(error) {
              console.error("Failed to create page:", error);
              return null;
          }
      }

      // --- CORE LOGIC ---
      function renderBook() {
        bookContainer.innerHTML = '';
        if (!book || !book.pages) {
            console.error("Book data is not available for rendering.");
            return;
        }

        const displayPages = [...book.pages];

        const quotes = [
            "Học, học nữa, học mãi.",
            "Đi một ngày đàng, học một sàng khôn.",
            "Có công mài sắt, có ngày nên kim.",
            "Không thầy đố mày làm nên.",
            "Muốn biết phải hỏi, muốn giỏi phải học."
        ];
        const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];


        // Always add a cover page first
        const coverImageUrl = book.cover_url || '/static/images/default-book-cover.jpg';
        const coverContent = `
            <div class="cover-author">${book.author_name || 'Ẩn danh'}</div>
            <h1 class="cover-title">${book.title || 'Book Title'}</h1>
            <img class="cover-image" src="${coverImageUrl}" alt="Cover Image" onerror="this.src='/static/images/default-book-cover.jpg'">
            ${book.description ? `<div class="cover-description">${book.description}</div>` : ''}
        `;
        displayPages.unshift({id: 'cover', page_number: 0, content: coverContent});
        
        // Add back cover
        displayPages.push({id: 'back-cover', page_number: displayPages.length + 1, content: randomQuote});
        
        const numSheets = Math.ceil(displayPages.length / 2);

        for (let index = 0; index < numSheets; index++) {
          const sheet = document.createElement('div');
          const isFlipped = index < currentSpread;
          sheet.className = 'sheet';
          if (isFlipped) {
            sheet.classList.add('flipped');
          }
          sheet.style.zIndex = isFlipped ? index + 1 : numSheets - index;
          
          const frontPageIndexInSheet = index * 2;
          const backPageIndexInSheet = frontPageIndexInSheet + 1;
          
          const frontPageData = displayPages[frontPageIndexInSheet];
          const backPageData = displayPages[backPageIndexInSheet];

          const isCoverSheet = frontPageData && frontPageData.id === 'cover';
          const isBackCoverSheet = backPageData && backPageData.id === 'back-cover';

          // Front page
          if (frontPageData) {
              const pageFront = document.createElement('div');
              pageFront.className = 'page page-front';
              if (isCoverSheet) pageFront.classList.add('is-cover');

              const pageContentFront = document.createElement('div');
              pageContentFront.className = 'page-content';
              
              const editableFront = document.createElement('div');
              editableFront.contentEditable = String(!isCoverSheet);
              editableFront.className = 'editable-area';
              editableFront.setAttribute('data-page-id', frontPageData.id);
              editableFront.setAttribute('data-page-index', frontPageIndexInSheet);
              editableFront.setAttribute('placeholder', `Start writing on page ${frontPageData.page_number}...`);
              editableFront.innerHTML = frontPageData.content || '';
              
              if (!isCoverSheet) {
                editableFront.addEventListener('input', handlePageInput);
              }
              editableFront.addEventListener('focus', () => { activeEditableArea = editableFront; });

              const pageNumFront = document.createElement('div');
              pageNumFront.className = 'page-number-right';
              pageNumFront.textContent = frontPageData.page_number;

              pageContentFront.appendChild(editableFront);
              if(!isCoverSheet) {
                pageContentFront.appendChild(pageNumFront);
              }
              pageFront.appendChild(pageContentFront);
              sheet.appendChild(pageFront);
          }
          
          // Back page
          if (backPageData) {
              const pageBack = document.createElement('div');
              pageBack.className = 'page page-back';
              if (isBackCoverSheet) pageBack.classList.add('is-back-cover');

              const pageContentBack = document.createElement('div');
              pageContentBack.className = 'page-content';
              
              const editableBack = document.createElement('div');
              editableBack.contentEditable = String(!isBackCoverSheet && backPageData.id !== 'back-cover');
              editableBack.className = 'editable-area';
              editableBack.setAttribute('data-page-id', backPageData.id);
              editableBack.setAttribute('data-page-index', backPageIndexInSheet);
              editableBack.setAttribute('placeholder', `Start writing on page ${backPageData.page_number}...`);
              editableBack.innerHTML = backPageData.content || '';
              
              if (!isBackCoverSheet) {
                editableBack.addEventListener('input', handlePageInput);
              }
              editableBack.addEventListener('focus', () => { activeEditableArea = editableBack; });


              const pageNumBack = document.createElement('div');
              pageNumBack.className = 'page-number-left';
              pageNumBack.textContent = backPageData.page_number;

              pageContentBack.appendChild(editableBack);
              if (!pageBack.classList.contains('is-back-cover')) {
                pageContentBack.appendChild(pageNumBack);
              }
              pageBack.appendChild(pageContentBack);
              sheet.appendChild(pageBack);
          }
          bookContainer.appendChild(sheet);
        }
        updateButtons();
      }

      function handlePageInput(event) {
          const editableArea = event.target;
          const pageId = editableArea.dataset.pageId;

          if (pageId === 'cover' || pageId === 'back-cover' || isNaN(parseInt(pageId))) return;

          clearTimeout(debounceTimeout);
          debounceTimeout = setTimeout(() => {
              const pageIndex = book.pages.findIndex(p => p.id == pageId);
              if (pageIndex > -1) {
                  const content = editableArea.innerHTML;
                  if (book.pages[pageIndex].content !== content) {
                    book.pages[pageIndex].content = content;
                    updatePage(pageId, { content: content });
                  }
              }
          }, DEBOUNCE_DELAY);
      }
      
      function updateButtons() {
        if (!book || !book.pages) return;
        const numSheets = Math.ceil((book.pages.length + 2) / 2); // +2 for covers
        prevBtn.disabled = currentSpread === 0 || isFlipping;
        nextBtn.disabled = currentSpread >= numSheets || isFlipping;

        if (currentSpread === 0) {
            bookContainer.classList.add('closed');
        } else {
            bookContainer.classList.remove('closed');
        }
      }

      function flip(sheetElement, to) {
        isFlipping = true;
        updateButtons();
        
        const numSheets = bookContainer.children.length;
        if (to === 'next') {
            sheetElement.classList.add('flipped');
            sheetElement.style.zIndex = currentSpread + numSheets;
        } else {
            sheetElement.classList.remove('flipped');
            sheetElement.style.zIndex = numSheets - currentSpread + 1;
        }

        setTimeout(() => {
          isFlipping = false;
          updateButtons();
        }, FLIP_DURATION);
      }

      function goToNextSpread() {
        const numSheets = bookContainer.children.length;
        if (currentSpread < numSheets && !isFlipping) {
          const sheetToFlip = bookContainer.children[currentSpread];
          if (sheetToFlip) {
            flip(sheetToFlip, 'next');
            currentSpread++;
          }
        }
      }

      function goToPrevSpread() {
        if (currentSpread > 0 && !isFlipping) {
          currentSpread--;
          const sheetToFlip = bookContainer.children[currentSpread];
          if (sheetToFlip) {
            flip(sheetToFlip, 'prev');
          }
        }
      }

      async function handleAddPage() {
        addPageBtn.disabled = true;
        const lastPageNum = book.pages.length > 0 ? book.pages[book.pages.length - 1].page_number : 0;
        
        // Always add two pages to maintain layout
        const newPage1Data = { page_number: lastPageNum + 1, title: `Page ${lastPageNum + 1}`, content: '' };
        const newPage2Data = { page_number: lastPageNum + 2, title: `Page ${lastPageNum + 2}`, content: '' };
        
        const createdPage1 = await createPage(newPage1Data);
        if (createdPage1) book.pages.push(createdPage1);

        const createdPage2 = await createPage(newPage2Data);
        if (createdPage2) book.pages.push(createdPage2);
        
        book.pages.sort((a, b) => a.page_number - b.page_number);
        renderBook();
        addPageBtn.disabled = false;
      }

      function formatDoc(cmd, value = null) {
        if (activeEditableArea) {
            activeEditableArea.focus();
            document.execCommand(cmd, false, value);
            const event = new Event('input', { bubbles: true, cancelable: true });
            activeEditableArea.dispatchEvent(event);
        }
      }
      
      function triggerSave(element) {
        if(element) {
            const event = new Event('input', { bubbles: true, cancelable: true });
            element.dispatchEvent(event);
        }
      }

      // --- MODAL LOGIC ---
      function showInputModal(title, fields, callback) {
        inputModalTitle.textContent = title;
        inputModalContent.innerHTML = '';
        fields.forEach(field => {
            const label = `<label for="modal-input-${field.id}">${field.label}</label>`;
            let input;
            if (field.type === 'color') {
                 input = `<input type="color" id="modal-input-${field.id}" value="${field.value || ''}">`;
            } else {
                 input = `<input type="${field.type || 'text'}" id="modal-input-${field.id}" placeholder="${field.placeholder || ''}" value="${field.value || ''}">`;
            }
            inputModalContent.innerHTML += label + input;
        });
        inputModal.style.display = 'block';
        inputModalOverlay.style.display = 'block';
        inputModalCallback = callback;
      }

      function hideInputModal() {
          inputModal.style.display = 'none';
          inputModalOverlay.style.display = 'none';
          inputModalCallback = null;
      }
      
      inputModalSaveBtn.addEventListener('click', () => {
          if (inputModalCallback) {
              const inputs = inputModalContent.querySelectorAll('input');
              const values = {};
              inputs.forEach(input => {
                  values[input.id.replace('modal-input-', '')] = input.value;
              });
              inputModalCallback(values);
          }
          hideInputModal();
      });
      inputModalCancelBtn.addEventListener('click', hideInputModal);

      // --- TOOLBAR EVENT LISTENERS ---
      boldBtn.addEventListener('click', () => formatDoc('bold'));
      italicBtn.addEventListener('click', () => formatDoc('italic'));
      underlineBtn.addEventListener('click', () => formatDoc('underline'));
      imageBtn.addEventListener('click', () => imageUpload.click());

      fontsizeBtn.addEventListener('click', () => {
        showInputModal('Font Size', [{id: 'size', label: 'Enter font size (e.g., 16px):'}], (values) => {
          if (values.size && activeEditableArea) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && selection.toString().length > 0) {
              const range = selection.getRangeAt(0);
              const span = document.createElement('span');
              span.style.fontSize = values.size;
              try {
                span.appendChild(range.extractContents());
                range.insertNode(span);
                triggerSave(activeEditableArea);
              } catch(e) { console.error(e); }
            }
          }
        });
      });
      
      fontcolorBtn.addEventListener('click', () => {
        showInputModal('Font Color', [{id: 'color', label: 'Enter font color:', type: 'color', value: '#ffffff'}], (values) => {
          if (values.color) {
            formatDoc('foreColor', values.color);
          }
        });
      });
      
      tableBtn.addEventListener('click', () => {
        showInputModal('Insert Table', [
            {id: 'rows', label: 'Number of rows:', type: 'number', value: '3'},
            {id: 'cols', label: 'Number of columns:', type: 'number', value: '3'}
        ], (values) => {
          const rows = parseInt(values.rows, 10);
          const cols = parseInt(values.cols, 10);
          if (rows > 0 && cols > 0 && activeEditableArea) {
              let table = '<table border="1"><tbody>';
              for (let i = 0; i < rows; i++) {
                  table += '<tr>';
                  for (let j = 0; j < cols; j++) {
                      table += '<td>&nbsp;</td>';
                  }
                  table += '</tr>';
              }
              table += '</tbody></table>';
              formatDoc('insertHTML', table + '<p></p>');
          }
        });
      });

      imageUpload.addEventListener('change', () => {
        const file = imageUpload.files[0];
        if (file && activeEditableArea) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = `<img src="${e.target.result}" style="max-width: 100%;" />`;
                formatDoc('insertHTML', img);
            };
            reader.readAsDataURL(file);
        }
        imageUpload.value = '';
      });


      // --- HIGHLIGHT LOGIC ---
      function showHighlightPopover(range) {
        const rect = range.getBoundingClientRect();
        highlightPopover.style.display = 'flex';
        highlightPopover.style.left = `${rect.left + window.scrollX + rect.width / 2 - highlightPopover.offsetWidth / 2}px`;
        highlightPopover.style.top = `${rect.top + window.scrollY - highlightPopover.offsetHeight - 8}px`;
      }
      
      function hideHighlightPopover() {
        highlightPopover.style.display = 'none';
      }

      function showHighlightModal() {
        noteInput.value = '';
        const selectedColor = colorPicker.querySelector('.selected');
        if(selectedColor) selectedColor.classList.remove('selected');
        colorPicker.children[0].classList.add('selected');

        highlightModalOverlay.style.display = 'block';
        highlightModal.style.display = 'block';
      }

      function hideHighlightModal() {
        highlightModalOverlay.style.display = 'none';
        highlightModal.style.display = 'none';
        currentSelection = null;
      }
      
      document.addEventListener('mouseup', (e) => {
          setTimeout(() => {
            const selection = window.getSelection();
            if (selection.isCollapsed || isFlipping || highlightModal.style.display === 'block' || inputModal.style.display === 'block') {
                hideHighlightPopover();
                return;
            }
            
            const range = selection.getRangeAt(0);
            let editable = range.commonAncestorContainer.nodeType === Node.ELEMENT_NODE
                ? range.commonAncestorContainer.closest('.editable-area')
                : range.commonAncestorContainer.parentElement.closest('.editable-area');

            if (editable) {
                currentSelection = range.cloneRange();
                showHighlightPopover(range);
            } else {
                hideHighlightPopover();
            }
          }, 10);
      });
      
      document.addEventListener('mousedown', (e) => {
          if (!highlightPopover.contains(e.target)) {
              hideHighlightPopover();
          }
      });
      
      document.addEventListener('click', (e) => {
        if(e.target.tagName === 'IMG' && e.target.closest('.editable-area')) {
            selectedImage = e.target;
            showInputModal('Image Size', [{id: 'width', label: 'Enter new image width (e.g., 300px or 50%):', value: selectedImage.style.width}], (values) => {
                if(values.width) {
                    selectedImage.style.width = values.width;
                    selectedImage.style.height = 'auto';
                    triggerSave(selectedImage.closest('.editable-area'));
                }
                selectedImage = null;
            });
        }
      });

      popoverHighlightBtn.addEventListener('click', () => {
          if (currentSelection) {
              hideHighlightPopover();
              showHighlightModal();
          }
      });

      popoverRemoveHighlightBtn.addEventListener('click', () => {
        if(currentSelection) {
            const ancestor = currentSelection.commonAncestorContainer;
            const mark = ancestor.nodeType === Node.ELEMENT_NODE ? ancestor.closest('mark') : ancestor.parentElement.closest('mark');
            if(mark) {
                const parent = mark.parentNode;
                while (mark.firstChild) {
                    parent.insertBefore(mark.firstChild, mark);
                }
                parent.removeChild(mark);
                parent.normalize(); // Merges adjacent text nodes
                triggerSave(parent.closest('.editable-area'));
            }
            hideHighlightPopover();
            window.getSelection().removeAllRanges();
        }
      });

      colorPicker.addEventListener('click', (e) => {
          if(e.target.classList.contains('color-box')) {
              const selectedColor = colorPicker.querySelector('.selected');
              if(selectedColor) selectedColor.classList.remove('selected');
              e.target.classList.add('selected');
          }
      });

      highlightModalCancelBtn.addEventListener('click', hideHighlightModal);

      highlightModalSaveBtn.addEventListener('click', () => {
        if (!currentSelection) return;

        const noteText = noteInput.value;
        const selectedColorEl = colorPicker.querySelector('.selected');
        const color = selectedColorEl.dataset.color;

        const mark = document.createElement('mark');
        mark.style.backgroundColor = color;
        
        if (noteText) {
            const noteSpan = document.createElement('span');
            noteSpan.className = 'highlight-note';
            noteSpan.textContent = noteText;
            mark.appendChild(noteSpan);
        }

        try {
          mark.appendChild(currentSelection.extractContents());
          currentSelection.insertNode(mark);
        } catch(e) {
            console.error("Could not apply highlight:", e);
            hideHighlightModal();
            return;
        }

        triggerSave(mark.closest('.editable-area'));
        hideHighlightModal();
        window.getSelection().removeAllRanges();
      });

      // --- INITIALIZATION ---
      fetchBook();
      prevBtn.addEventListener('click', goToPrevSpread);
      nextBtn.addEventListener('click', goToNextSpread);
      addPageBtn.addEventListener('click', handleAddPage);
    });
  </script>
</body>
</html>
<article class="post-detail">
    <header class="hero hero-basic">
        <div class="hero-header">
            <div class="hero-text">
                <h1>{{.Post.Title}}</h1>
                <p class="meta">B·ªüi {{.Post.AuthorName}} ¬∑ {{.Post.CreatedLabel}}</p>
            </div>
        </div>
        {{if .Post.Summary}}
        <p class="summary">{{.Post.Summary}}</p>
        {{end}}
    </header>

    <section class="card" style="max-width: 1400px; margin: 2rem auto;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <!-- Editor Section -->
            <div>
                <h2 style="margin-bottom: 1rem; color: #f1f5f9;">Ch·ªânh s·ª≠a b√†i vi·∫øt</h2>
                <form method="post" action="/posts/{{.Post.ID}}/edit" id="custom-edit-form">
                    <div class="stack" style="gap: 1rem;">
                        <label>
                            <span style="display: block; margin-bottom: 0.5rem; color: #cbd5e1;">T·ª±a ƒë·ªÅ</span>
                            <input type="text" name="title" value="{{.Post.Title}}" required style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.65); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 6px; color: #e2e8f0;">
                        </label>

                        <label>
                            <span style="display: block; margin-bottom: 0.5rem; color: #cbd5e1;">T√≥m t·∫Øt</span>
                            <input type="text" name="summary" value="{{.Post.Summary}}" style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.65); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 6px; color: #e2e8f0;">
                        </label>

                        <label>
                            <span style="display: block; margin-bottom: 0.5rem; color: #cbd5e1;">·∫¢nh b√¨a (URL)</span>
                            <input type="url" name="cover_url" value="{{.Post.CoverURL}}" style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.65); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 6px; color: #e2e8f0;">
                        </label>

                        <label>
                            <span style="display: block; margin-bottom: 0.5rem; color: #cbd5e1;">Tags</span>
                            <input type="text" name="tags" value="{{.Post.Tags}}" placeholder="docker, kubernetes, ci-cd" style="width: 100%; padding: 0.75rem; background: rgba(15, 23, 42, 0.65); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 6px; color: #e2e8f0;">
                        </label>

                        <div>
                            <span style="display: block; margin-bottom: 0.5rem; color: #cbd5e1;">N·ªôi dung b√†i vi·∫øt</span>
                            <div id="lines-editor" style="background: rgba(15, 23, 42, 0.65); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 6px; padding: 1rem; max-height: 500px; overflow-y: auto;">
                                <!-- Lines will be inserted here -->
                            </div>
                            <button type="button" id="add-line" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: rgba(56, 189, 248, 0.1); border: 1px dashed rgba(56, 189, 248, 0.3); border-radius: 4px; color: #38bdf8; cursor: pointer; width: 100%;">
                                + Th√™m d√≤ng m·ªõi
                            </button>
                        </div>

                        <textarea name="content" id="content-hidden" hidden>{{.Post.Content}}</textarea>
                        <input type="hidden" name="line_annotations" id="annotations-hidden">

                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button type="submit" class="btn primary" style="flex: 1;">üíæ L∆∞u thay ƒë·ªïi</button>
                            <a href="/posts/{{.Post.ID}}" class="btn ghost" style="flex: 1; text-align: center;">H·ªßy</a>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Preview Section -->
            <div>
                <h2 style="margin-bottom: 1rem; color: #f1f5f9;">Xem tr∆∞·ªõc</h2>
                <div class="card" style="background: rgba(15, 23, 42, 0.65); border: 1px solid rgba(148, 163, 184, 0.3); padding: 2rem;">
                    <h3 id="preview-title" style="font-size: 1.75rem; margin-bottom: 0.5rem;">{{.Post.Title}}</h3>
                    <p style="color: #94a3b8; margin-bottom: 1rem;">B·ªüi {{.Post.AuthorName}} ¬∑ {{.Post.CreatedLabel}}</p>
                    <p id="preview-summary" style="color: #cbd5e1; margin-bottom: 1.5rem; font-style: italic;">{{.Post.Summary}}</p>
                    <div id="preview-content" style="color: #e2e8f0; line-height: 1.8;">
                        {{.Post.Content | safeHTML}}
                    </div>
                </div>
            </div>
        </div>
    </section>
</article>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const linesEditor = document.getElementById('lines-editor');
    const addLineBtn = document.getElementById('add-line');
    const contentHidden = document.getElementById('content-hidden');
    const annotationsHidden = document.getElementById('annotations-hidden');
    const form = document.getElementById('custom-edit-form');
    
    // Preview elements
    const previewTitle = document.getElementById('preview-title');
    const previewSummary = document.getElementById('preview-summary');
    const previewContent = document.getElementById('preview-content');
    
    // Load existing annotations
    const existingAnnotations = {{.LineAnnotations | json}} || {};
    
    // Parse HTML content into lines
    function parseContent(html) {
        if (!html) return [];
        const temp = document.createElement('div');
        temp.innerHTML = html;
        const elements = temp.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, div');
        return Array.from(elements).map(el => el.textContent.trim()).filter(t => t.length > 0);
    }
    
    // Create a line element
    function createLine(text = '', notice = '', lineNum = 1) {
        const lineDiv = document.createElement('div');
        lineDiv.className = 'editor-line';
        lineDiv.dataset.line = lineNum;
        lineDiv.style.cssText = `
            display: grid;
            grid-template-columns: 40px 1fr 220px 40px;
            gap: 0.5rem;
            align-items: start;
            padding: 0.75rem;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        `;
        
        // Line number
        const numSpan = document.createElement('span');
        numSpan.textContent = lineNum;
        numSpan.style.cssText = `
            color: #64748b;
            font-size: 0.875rem;
            padding-top: 0.5rem;
            text-align: center;
            font-weight: 600;
        `;
        
        // Content textarea
        const textarea = document.createElement('textarea');
        textarea.className = 'line-text';
        textarea.value = text;
        textarea.placeholder = 'Nh·∫≠p n·ªôi dung d√≤ng...';
        textarea.rows = 1;
        textarea.style.cssText = `
            width: 100%;
            padding: 0.5rem;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 4px;
            color: #e2e8f0;
            font-size: 1rem;
            resize: none;
            overflow: hidden;
            font-family: inherit;
            line-height: 1.5;
        `;
        
        // Auto-resize
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
            updatePreview();
        });
        
        // Initial resize
        setTimeout(() => {
            textarea.style.height = textarea.scrollHeight + 'px';
        }, 0);
        
        // Notice input
        const noticeInput = document.createElement('input');
        noticeInput.type = 'text';
        noticeInput.className = 'line-notice';
        noticeInput.value = notice;
        noticeInput.placeholder = `# Notice ${lineNum}`;
        noticeInput.style.cssText = `
            width: 100%;
            padding: 0.5rem;
            background: rgba(76, 29, 149, 0.2);
            border: 1px solid rgba(168, 85, 247, 0.4);
            border-radius: 4px;
            color: #c4b5fd;
            font-size: 0.875rem;
            font-style: italic;
        `;
        
        noticeInput.addEventListener('input', updatePreview);
        
        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.innerHTML = 'üóëÔ∏è';
        deleteBtn.title = 'X√≥a d√≤ng';
        deleteBtn.style.cssText = `
            padding: 0.5rem;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 4px;
            color: #ef4444;
            cursor: pointer;
            font-size: 1.2rem;
        `;
        
        deleteBtn.addEventListener('click', () => {
            lineDiv.remove();
            renumberLines();
            updatePreview();
        });
        
        lineDiv.appendChild(numSpan);
        lineDiv.appendChild(textarea);
        lineDiv.appendChild(noticeInput);
        lineDiv.appendChild(deleteBtn);
        
        return lineDiv;
    }
    
    // Renumber all lines
    function renumberLines() {
        const lines = linesEditor.querySelectorAll('.editor-line');
        lines.forEach((line, index) => {
            const num = index + 1;
            line.dataset.line = num;
            line.querySelector('span').textContent = num;
            line.querySelector('.line-notice').placeholder = `# Notice ${num}`;
        });
    }
    
    // Update preview
    function updatePreview() {
        const lines = linesEditor.querySelectorAll('.editor-line');
        let html = '';
        const annotations = {};
        
        lines.forEach((line, index) => {
            const text = line.querySelector('.line-text').value.trim();
            const notice = line.querySelector('.line-notice').value.trim();
            const lineNum = index + 1;
            
            if (text) {
                html += `<p>${text}</p>\n`;
            }
            
            if (notice) {
                annotations[lineNum] = notice;
            }
        });
        
        contentHidden.value = html;
        annotationsHidden.value = JSON.stringify(annotations);
        previewContent.innerHTML = html || '<p style="color: #64748b;">N·ªôi dung tr·ªëng</p>';
    }
    
    // Add new line
    addLineBtn.addEventListener('click', () => {
        const lineNum = linesEditor.querySelectorAll('.editor-line').length + 1;
        const newLine = createLine('', '', lineNum);
        linesEditor.appendChild(newLine);
        newLine.querySelector('.line-text').focus();
    });
    
    // Load existing content
    const existingLines = parseContent(contentHidden.value);
    if (existingLines.length > 0) {
        existingLines.forEach((text, index) => {
            const lineNum = index + 1;
            const notice = existingAnnotations[lineNum] || '';
            linesEditor.appendChild(createLine(text, notice, lineNum));
        });
    } else {
        // Add first empty line
        linesEditor.appendChild(createLine('', '', 1));
    }
    
    // Preview other fields
    form.querySelectorAll('input[name="title"]').forEach(input => {
        input.addEventListener('input', () => {
            previewTitle.textContent = input.value || 'Ti√™u ƒë·ªÅ b√†i vi·∫øt';
        });
    });
    
    form.querySelectorAll('input[name="summary"]').forEach(input => {
        input.addEventListener('input', () => {
            previewSummary.textContent = input.value || 'T√≥m t·∫Øt ng·∫Øn g·ªçn';
        });
    });
    
    // Form submit
    form.addEventListener('submit', (e) => {
        updatePreview(); // Ensure latest data
    });
});
</script>

<style>
.editor-line:hover {
    background: rgba(30, 41, 59, 0.8) !important;
}

.line-text:focus,
.line-notice:focus {
    outline: none;
    border-color: rgba(56, 189, 248, 0.5);
    box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1);
}

.btn {
    padding: 0.75rem 1.5rem;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
}

.btn.primary {
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    color: white;
    border: none;
}

.btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

.btn.ghost {
    background: transparent;
    border: 1px solid rgba(148, 163, 184, 0.3);
    color: #cbd5e1;
}

.btn.ghost:hover {
    background: rgba(148, 163, 184, 0.1);
    border-color: rgba(148, 163, 184, 0.5);
}
</style>

<article class="post-detail">
    <header class="hero hero-basic">
        <div class="hero-header">
            <div class="hero-text">
                <h1>Ch·ªânh s·ª≠a b√†i vi·∫øt</h1>
                <p class="meta">{{.Post.Title}}</p>
            </div>
        </div>
    </header>

    <section class="card" style="max-width: 1400px; margin: 2rem auto;">
        <div style="display: grid; grid-template-columns: 1fr 400px; gap: 2rem;">
            <!-- Main Editor -->
            <div>
                <form method="post" action="/posts/{{.Post.ID}}/edit" id="edit-form">
                    <div class="stack" style="gap: 1rem;">
                        <label>
                            <span style="display: block; margin-bottom: 0.5rem; color: #cbd5e1; font-weight: 500;">T·ª±a ƒë·ªÅ</span>
                            <input type="text" name="title" value="{{.Post.Title}}" required class="form-input">
                        </label>

                        <label>
                            <span style="display: block; margin-bottom: 0.5rem; color: #cbd5e1; font-weight: 500;">T√≥m t·∫Øt</span>
                            <input type="text" name="summary" value="{{.Post.Summary}}" class="form-input">
                        </label>

                        <label>
                            <span style="display: block; margin-bottom: 0.5rem; color: #cbd5e1; font-weight: 500;">·∫¢nh b√¨a (URL)</span>
                            <input type="url" name="cover_url" value="{{.Post.CoverURL}}" class="form-input">
                        </label>

                        <label>
                            <span style="display: block; margin-bottom: 0.5rem; color: #cbd5e1; font-weight: 500;">Tags</span>
                            <input type="text" name="tags" value="{{.Post.Tags}}" placeholder="docker, kubernetes, ci-cd" class="form-input">
                        </label>

                        <div>
                            <span style="display: block; margin-bottom: 0.5rem; color: #cbd5e1; font-weight: 500;">N·ªôi dung b√†i vi·∫øt</span>
                            <div id="editor-container" style="min-height: 400px; background: rgba(15, 23, 42, 0.65); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 8px;"></div>
                        </div>

                        <textarea name="content" id="content-hidden" hidden>{{.Post.Content}}</textarea>
                        <input type="hidden" name="line_annotations" id="annotations-hidden">

                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ L∆∞u thay ƒë·ªïi</button>
                            <a href="/posts/{{.Post.ID}}" class="btn btn-ghost" style="flex: 1; text-align: center;">H·ªßy</a>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Notice Sidebar -->
            <div>
                <div style="position: sticky; top: 2rem;">
                    <h3 style="margin-bottom: 1rem; color: #f1f5f9; font-size: 1.1rem;">üìù Notice Inline</h3>
                    <div id="notices-container" style="background: rgba(15, 23, 42, 0.65); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 8px; padding: 1rem; max-height: 500px; overflow-y: auto;">
                        <p style="color: #64748b; font-size: 0.875rem; text-align: center; padding: 2rem;">
                            Nh·∫≠p n·ªôi dung b√™n tr√°i.<br>Notice inputs s·∫Ω xu·∫•t hi·ªán t∆∞∆°ng ·ª©ng v·ªõi m·ªói d√≤ng.
                        </p>
                    </div>
                    
                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(76, 29, 149, 0.1); border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 6px;">
                        <p style="color: #c4b5fd; font-size: 0.875rem; margin: 0;">
                            üí° <strong>Tip:</strong> Notice inline gi√∫p b·∫°n th√™m ghi ch√∫, gi·∫£i th√≠ch cho t·ª´ng d√≤ng code ho·∫∑c ƒëo·∫°n vƒÉn.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</article>

<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<style>
.form-input {
    width: 100%;
    padding: 0.75rem;
    background: rgba(15, 23, 42, 0.65);
    border: 1px solid rgba(148, 163, 184, 0.3);
    border-radius: 6px;
    color: #e2e8f0;
    font-size: 1rem;
    transition: all 0.2s;
}

.form-input:focus {
    outline: none;
    border-color: rgba(56, 189, 248, 0.5);
    box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1);
}

.btn {
    padding: 0.75rem 1.5rem;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
    border: none;
    font-size: 1rem;
}

.btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

.btn-ghost {
    background: transparent;
    border: 1px solid rgba(148, 163, 184, 0.3);
    color: #cbd5e1;
}

.btn-ghost:hover {
    background: rgba(148, 163, 184, 0.1);
    border-color: rgba(148, 163, 184, 0.5);
}

/* Quill customization */
.ql-toolbar.ql-snow {
    background: rgba(30, 41, 59, 0.8);
    border: 1px solid rgba(148, 163, 184, 0.3);
    border-radius: 8px 8px 0 0;
    padding: 0.75rem;
}

.ql-container.ql-snow {
    background: rgba(15, 23, 42, 0.65);
    border: 1px solid rgba(148, 163, 184, 0.3);
    border-top: none;
    border-radius: 0 0 8px 8px;
    color: #e2e8f0;
    font-size: 1rem;
}

.ql-editor {
    min-height: 400px;
    color: #e2e8f0;
}

.ql-editor p,
.ql-editor h1,
.ql-editor h2,
.ql-editor h3 {
    color: #e2e8f0;
}

.ql-snow .ql-stroke {
    stroke: #94a3b8;
}

.ql-snow .ql-fill {
    fill: #94a3b8;
}

.ql-snow .ql-picker-label {
    color: #94a3b8;
}

.ql-toolbar button:hover,
.ql-toolbar button.ql-active {
    color: #38bdf8;
}

.ql-toolbar button:hover .ql-stroke,
.ql-toolbar button.ql-active .ql-stroke {
    stroke: #38bdf8;
}

.ql-toolbar button:hover .ql-fill,
.ql-toolbar button.ql-active .ql-fill {
    fill: #38bdf8;
}

/* Notice input styling */
.notice-item {
    display: flex;
    gap: 0.5rem;
    align-items: start;
    padding: 0.75rem;
    background: rgba(30, 41, 59, 0.5);
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 6px;
    margin-bottom: 0.5rem;
}

.notice-item:hover {
    background: rgba(30, 41, 59, 0.8);
    border-color: rgba(168, 85, 247, 0.3);
}

.notice-line-num {
    min-width: 30px;
    padding: 0.5rem;
    background: rgba(168, 85, 247, 0.2);
    border-radius: 4px;
    color: #c4b5fd;
    font-weight: 600;
    text-align: center;
    font-size: 0.875rem;
}

.notice-input {
    flex: 1;
    padding: 0.5rem;
    background: rgba(76, 29, 149, 0.2);
    border: 1px solid rgba(168, 85, 247, 0.3);
    border-radius: 4px;
    color: #c4b5fd;
    font-size: 0.875rem;
    font-style: italic;
    resize: vertical;
    min-height: 40px;
}

.notice-input:focus {
    outline: none;
    border-color: rgba(168, 85, 247, 0.5);
    box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
}

.notice-input::placeholder {
    color: rgba(196, 181, 253, 0.5);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('edit-form');
    const contentHidden = document.getElementById('content-hidden');
    const annotationsHidden = document.getElementById('annotations-hidden');
    const noticesContainer = document.getElementById('notices-container');
    
    // Load existing annotations
    const existingAnnotations = {{.LineAnnotations | json}} || {};
    
    // Initialize Quill with rich formatting
    const quill = new Quill('#editor-container', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'indent': '-1'}, { 'indent': '+1' }],
                ['blockquote', 'code-block'],
                ['link', 'image'],
                ['clean']
            ]
        }
    });
    
    // Load existing content
    if (contentHidden.value) {
        const delta = quill.clipboard.convert(contentHidden.value);
        quill.setContents(delta, 'silent');
    }
    
    // Parse content into lines
    function parseLines() {
        const html = quill.root.innerHTML;
        const temp = document.createElement('div');
        temp.innerHTML = html;
        
        const lines = [];
        const elements = temp.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, pre');
        
        elements.forEach(el => {
            const text = el.textContent.trim();
            if (text) {
                lines.push(text);
            }
        });
        
        return lines;
    }
    
    // Update notice inputs
    function updateNotices() {
        const lines = parseLines();
        
        if (lines.length === 0) {
            noticesContainer.innerHTML = `
                <p style="color: #64748b; font-size: 0.875rem; text-align: center; padding: 2rem;">
                    Nh·∫≠p n·ªôi dung b√™n tr√°i.<br>Notice inputs s·∫Ω xu·∫•t hi·ªán t∆∞∆°ng ·ª©ng v·ªõi m·ªói d√≤ng.
                </p>
            `;
            return;
        }
        
        // Save current values
        const currentValues = {};
        noticesContainer.querySelectorAll('.notice-input').forEach(input => {
            const lineNum = parseInt(input.dataset.line);
            if (input.value.trim()) {
                currentValues[lineNum] = input.value;
            }
        });
        
        // Merge with existing annotations
        const allNotices = { ...existingAnnotations, ...currentValues };
        
        // Rebuild notices
        noticesContainer.innerHTML = '';
        
        lines.forEach((lineText, index) => {
            const lineNum = index + 1;
            const preview = lineText.length > 40 ? lineText.substring(0, 40) + '...' : lineText;
            
            const noticeItem = document.createElement('div');
            noticeItem.className = 'notice-item';
            
            const lineNumSpan = document.createElement('div');
            lineNumSpan.className = 'notice-line-num';
            lineNumSpan.textContent = lineNum;
            
            const inputWrapper = document.createElement('div');
            inputWrapper.style.flex = '1';
            
            const linePreview = document.createElement('div');
            linePreview.style.cssText = 'color: #94a3b8; font-size: 0.75rem; margin-bottom: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
            linePreview.textContent = preview;
            
            const input = document.createElement('textarea');
            input.className = 'notice-input';
            input.dataset.line = lineNum;
            input.placeholder = `Notice cho d√≤ng ${lineNum}...`;
            input.value = allNotices[lineNum] || '';
            input.rows = 1;
            
            // Auto-resize
            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
            
            // Initial resize
            setTimeout(() => {
                input.style.height = input.scrollHeight + 'px';
            }, 0);
            
            inputWrapper.appendChild(linePreview);
            inputWrapper.appendChild(input);
            
            noticeItem.appendChild(lineNumSpan);
            noticeItem.appendChild(inputWrapper);
            
            noticesContainer.appendChild(noticeItem);
        });
    }
    
    // Update on text change
    quill.on('text-change', () => {
        // Save content
        contentHidden.value = quill.root.innerHTML;
        
        // Update notices with debounce
        clearTimeout(window.noticeUpdateTimer);
        window.noticeUpdateTimer = setTimeout(updateNotices, 300);
    });
    
    // Initial update
    updateNotices();
    
    // Form submit
    form.addEventListener('submit', (e) => {
        // Save content
        contentHidden.value = quill.root.innerHTML;
        
        // Collect notices
        const notices = {};
        noticesContainer.querySelectorAll('.notice-input').forEach(input => {
            const lineNum = input.dataset.line;
            const value = input.value.trim();
            if (value) {
                notices[lineNum] = value;
            }
        });
        
        annotationsHidden.value = JSON.stringify(notices);
    });
    
    // Preview other fields
    form.querySelectorAll('input[name="title"], input[name="summary"]').forEach(input => {
        input.addEventListener('input', () => {
            // Could add live preview here if needed
        });
    });
});
</script>

<article class="book-detail">
    <header class="hero hero-basic">
        <div class="hero-header">
            <div class="hero-text">
                <h1>{{.Book.Title}}</h1>
                <p class="meta">B·ªüi {{.Book.AuthorName}}</p>
            </div>
        </div>
        {{if .Book.Description}}
        <p class="summary">{{.Book.Description}}</p>
        {{end}}
    </header>

    <div class="book-meta-actions">
        <div class="book-status">
            {{if .Book.Published}}
            <span class="badge success">‚úì ƒê√£ xu·∫•t b·∫£n</span>
            {{else}}
            <span class="badge warning">üìù B·∫£n nh√°p</span>
            {{end}}
        </div>
        {{if .IsAuthor}}
        <div class="book-author-actions">
            <button type="button" class="btn ghost" data-action="toggle-settings">‚öôÔ∏è C√†i ƒë·∫∑t</button>
            <button type="button" class="btn primary" data-action="add-page">+ Th√™m trang</button>
        </div>
        {{end}}
    </div>

    <!-- Book Settings (Edit) -->
    {{if .IsAuthor}}
    <section class="card book-settings" id="book-settings" hidden>
        <h3>C√†i ƒë·∫∑t s√°ch</h3>
        <form id="book-settings-form" class="stack">
            <label>
                Ti√™u ƒë·ªÅ
                <input type="text" name="title" value="{{.Book.Title}}" required>
            </label>
            <label>
                M√¥ t·∫£
                <textarea name="description" rows="3">{{.Book.Description}}</textarea>
            </label>
            <label>
                ·∫¢nh b√¨a (URL)
                <input type="url" name="cover_url" value="{{.Book.CoverURL}}">
            </label>
            <label>
                M√†u b√¨a s√°ch
                <input type="color" name="cover_color" value="{{if .Book.CoverColor}}{{.Book.CoverColor}}{{else}}#1e293b{{end}}">
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" name="published" {{if .Book.Published}}checked{{end}}>
                <span>Xu·∫•t b·∫£n s√°ch (cho ph√©p ng∆∞·ªùi kh√°c xem)</span>
            </label>
            <div class="form-actions">
                <button type="button" class="btn ghost" data-action="cancel-settings">H·ªßy</button>
                <button type="submit" class="btn primary">L∆∞u thay ƒë·ªïi</button>
            </div>
        </form>
    </section>
    {{end}}

    <!-- Pages List -->
    <section class="card book-pages">
        <h3>Danh s√°ch trang ({{len .Book.Pages}})</h3>
        {{if .Book.Pages}}
        <div class="pages-list">
            {{range .Book.Pages}}
            <div class="page-item" data-page-id="{{.ID}}">
                <div class="page-number">{{.PageNumber}}</div>
                <div class="page-info">
                    <h4>{{if .Title}}{{.Title}}{{else}}Trang {{.PageNumber}}{{end}}</h4>
                    <p class="page-preview">{{.Content | safeHTML}}</p>
                </div>
                {{if $.IsAuthor}}
                <div class="page-actions">
                    <button type="button" class="btn ghost btn-sm" data-action="edit-page" data-page-id="{{.ID}}">‚úèÔ∏è</button>
                    <button type="button" class="btn ghost btn-sm" data-action="delete-page" data-page-id="{{.ID}}">üóëÔ∏è</button>
                </div>
                {{end}}
            </div>
            {{end}}
        </div>
        {{else}}
        <p style="color: #94a3b8; text-align: center; padding: 2rem;">
            Ch∆∞a c√≥ trang n√†o. {{if .IsAuthor}}Nh·∫•n "Th√™m trang" ƒë·ªÉ b·∫Øt ƒë·∫ßu!{{end}}
        </p>
        {{end}}
    </section>

    <div class="book-read-action">
        <a href="/books/{{.Book.ID}}/read" class="btn primary">üìñ ƒê·ªçc s√°ch</a>
    </div>
</article>

{{if .IsAuthor}}
<!-- Page Editor Modal -->
<div id="page-editor-modal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2 id="page-editor-title">Th√™m trang m·ªõi</h2>
            <button type="button" class="modal-close" data-action="close-page-editor">√ó</button>
        </div>
        <div class="composer-grid">
            <form id="page-editor-form" class="stack">
                <input type="hidden" name="page_id" id="page-id">
                <label>
                    Ti√™u ƒë·ªÅ trang (t√πy ch·ªçn)
                    <input type="text" name="title" placeholder="Ti√™u ƒë·ªÅ trang">
                </label>
                <label>
                    N·ªôi dung
                    <div id="page-editor-container" style="min-height: 300px; background: rgba(15, 23, 42, 0.65); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 8px;"></div>
                    <textarea name="content" id="page-content-textarea" hidden></textarea>
                    <input type="hidden" name="line_annotations" id="page-line-annotations">
                </label>
                <div class="form-actions">
                    <button type="button" class="btn ghost" data-action="close-page-editor">H·ªßy</button>
                    <button type="submit" class="btn primary">L∆∞u trang</button>
                </div>
            </form>
            <aside class="preview" id="page-notice-sidebar">
                <h3 class="preview-heading">üìù Notice Inline</h3>
                <p style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 0.5rem;">Th√™m ghi ch√∫ cho t·ª´ng d√≤ng</p>
                
                <div style="margin-bottom: 1rem;">
                    <input 
                        type="text" 
                        id="page-notice-search" 
                        placeholder="üîç T√¨m ki·∫øm..." 
                        style="width: 100%; padding: 0.5rem; background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 6px; color: #e2e8f0; font-size: 0.9rem;"
                    >
                </div>
                
                <div id="page-notice-list" style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 500px; overflow-y: auto;">
                    <p style="color: #64748b; font-style: italic; font-size: 0.9rem;">Nh·∫≠p n·ªôi dung ƒë·ªÉ th·∫•y danh s√°ch d√≤ng...</p>
                </div>
            </aside>
        </div>
    </div>
</div>

<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<style>
.book-detail {
    display: grid;
    gap: 1.75rem;
}

.book-meta-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.book-author-actions {
    display: flex;
    gap: 0.75rem;
}

.badge {
    display: inline-block;
    padding: 0.4rem 1rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.badge.success {
    background: rgba(34, 197, 94, 0.15);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.3);
}

.badge.warning {
    background: rgba(251, 191, 36, 0.15);
    color: #fbbf24;
    border: 1px solid rgba(251, 191, 36, 0.3);
}

.pages-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 1rem;
}

.page-item {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: rgba(15, 23, 42, 0.4);
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 12px;
    align-items: flex-start;
}

.page-number {
    min-width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(56, 189, 248, 0.15);
    color: #38bdf8;
    border-radius: 12px;
    font-size: 1.2rem;
    font-weight: 600;
    flex-shrink: 0;
}

.page-info {
    flex: 1;
    min-width: 0;
}

.page-info h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1.1rem;
    color: #e2e8f0;
}

.page-preview {
    color: #94a3b8;
    font-size: 0.9rem;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.page-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
}

.btn-sm {
    padding: 0.4rem 0.8rem;
    font-size: 0.9rem;
}

.book-read-action {
    text-align: center;
    margin-top: 1rem;
}

.modal-large .modal-content {
    max-width: 1200px;
}

.composer-grid {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 1.5rem;
}

@media (max-width: 900px) {
    .composer-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
let pageQuill = null;
const bookId = {{.Book.ID}};

document.addEventListener('DOMContentLoaded', () => {
    // Settings toggle
    const settingsBtn = document.querySelector('[data-action="toggle-settings"]');
    const settingsSection = document.getElementById('book-settings');
    const cancelSettingsBtn = document.querySelector('[data-action="cancel-settings"]');

    if (settingsBtn && settingsSection) {
        settingsBtn.addEventListener('click', () => {
            settingsSection.hidden = !settingsSection.hidden;
        });

        cancelSettingsBtn?.addEventListener('click', () => {
            settingsSection.hidden = true;
        });
    }

    // Settings form
    const settingsForm = document.getElementById('book-settings-form');
    if (settingsForm) {
        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(settingsForm);
            const data = {
                title: formData.get('title'),
                description: formData.get('description'),
                cover_url: formData.get('cover_url'),
                cover_color: formData.get('cover_color'),
                published: formData.get('published') === 'on'
            };

            try {
                const response = await fetch(`/books/${bookId}/edit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert(result.error || 'L·ªói c·∫≠p nh·∫≠t');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('L·ªói k·∫øt n·ªëi');
            }
        });
    }

    // Page editor modal
    const addPageBtn = document.querySelector('[data-action="add-page"]');
    const pageEditorModal = document.getElementById('page-editor-modal');
    const pageEditorForm = document.getElementById('page-editor-form');
    const closeEditorBtns = document.querySelectorAll('[data-action="close-page-editor"]');

    if (addPageBtn && pageEditorModal) {
        // Initialize Quill
        pageQuill = new Quill('#page-editor-container', {
            theme: 'snow',
            placeholder: 'Nh·∫≠p n·ªôi dung trang...',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['link', 'image'],
                    ['clean']
                ]
            }
        });

        // Sync Quill to textarea and update notice sidebar
        pageQuill.on('text-change', function() {
            document.getElementById('page-content-textarea').value = pageQuill.root.innerHTML;
            updatePageNoticeInputs();
        });

        addPageBtn.addEventListener('click', () => {
            document.getElementById('page-editor-title').textContent = 'Th√™m trang m·ªõi';
            document.getElementById('page-id').value = '';
            pageEditorForm.reset();
            pageQuill.setContents([]);
            pageEditorModal.style.display = 'flex';
        });

        closeEditorBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                pageEditorModal.style.display = 'none';
            });
        });

        pageEditorModal.addEventListener('click', (e) => {
            if (e.target === pageEditorModal) {
                pageEditorModal.style.display = 'none';
            }
        });

        // Submit page
        pageEditorForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(pageEditorForm);
            const pageId = formData.get('page_id');
            
            // Collect notices
            const noticeData = {};
            document.querySelectorAll('#page-notice-list input[data-line]').forEach(input => {
                if (input.value.trim()) {
                    noticeData[input.dataset.line] = input.value.trim();
                }
            });

            const data = {
                title: formData.get('title'),
                content: pageQuill.root.innerHTML,
                line_annotations: JSON.stringify(noticeData)
            };

            try {
                let url, method;
                if (pageId) {
                    url = `/books/${bookId}/pages/${pageId}/edit`;
                    method = 'POST';
                } else {
                    url = `/books/${bookId}/pages`;
                    method = 'POST';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert(result.error || 'L·ªói l∆∞u trang');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('L·ªói k·∫øt n·ªëi');
            }
        });
    }

    // Delete page
    document.querySelectorAll('[data-action="delete-page"]').forEach(btn => {
        btn.addEventListener('click', async () => {
            if (!confirm('X√≥a trang n√†y?')) return;

            const pageId = btn.dataset.pageId;
            try {
                const response = await fetch(`/books/${bookId}/pages/${pageId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert(result.error || 'L·ªói x√≥a trang');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('L·ªói k·∫øt n·ªëi');
            }
        });
    });

    // Notice sidebar functions
    function updatePageNoticeInputs() {
        const noticeList = document.getElementById('page-notice-list');
        if (!pageQuill || !noticeList) return;

        requestAnimationFrame(() => {
            const lines = pageQuill.root.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li');
            const existingNotices = {};
            
            noticeList.querySelectorAll('input[data-line]').forEach(input => {
                if (input.value.trim()) {
                    existingNotices[input.dataset.line] = input.value.trim();
                }
            });

            noticeList.innerHTML = '';

            if (lines.length === 0) {
                noticeList.innerHTML = '<p style="color: #64748b; font-style: italic; font-size: 0.9rem;">Nh·∫≠p n·ªôi dung ƒë·ªÉ th·∫•y danh s√°ch d√≤ng...</p>';
                return;
            }

            let lineNum = 0;
            lines.forEach((line) => {
                const lineText = line.textContent.trim();
                if (!lineText) return;
                
                lineNum++;

                const noticeItem = document.createElement('div');
                noticeItem.className = 'notice-item';
                noticeItem.style.cssText = 'display: flex; flex-direction: column; gap: 0.5rem; padding: 0.75rem; background: rgba(15, 23, 42, 0.4); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 8px;';

                const header = document.createElement('div');
                header.style.cssText = 'display: flex; gap: 0.5rem; align-items: center;';
                
                const lineLabel = document.createElement('span');
                lineLabel.textContent = lineNum;
                lineLabel.style.cssText = 'min-width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: rgba(56, 189, 248, 0.15); color: #38bdf8; border-radius: 6px; font-size: 0.8rem; font-weight: 600;';
                
                const linePreview = document.createElement('div');
                linePreview.textContent = lineText.length > 50 ? lineText.substring(0, 50) + '...' : lineText;
                linePreview.style.cssText = 'color: #cbd5e1; font-size: 0.85rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1;';
                
                header.appendChild(lineLabel);
                header.appendChild(linePreview);

                const noticeInput = document.createElement('input');
                noticeInput.type = 'text';
                noticeInput.dataset.line = lineNum;
                noticeInput.placeholder = `Ghi ch√∫ cho d√≤ng ${lineNum}...`;
                noticeInput.value = existingNotices[lineNum] || '';
                noticeInput.style.cssText = 'padding: 0.5rem; background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 4px; color: #e2e8f0; font-size: 0.9rem;';

                noticeItem.appendChild(header);
                noticeItem.appendChild(noticeInput);
                noticeList.appendChild(noticeItem);
            });
        });
    }

    // Search functionality
    const searchInput = document.getElementById('page-notice-search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('#page-notice-list .notice-item').forEach(item => {
                const lineText = item.textContent.toLowerCase();
                item.style.display = lineText.includes(query) ? 'flex' : 'none';
            });
        });
    }
});
</script>
{{end}}
